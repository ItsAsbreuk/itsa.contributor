<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/event-dom/extra/dragdrop.js - Itsa</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Itsa"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/document.html">document</a></li>
            
                <li><a href="../classes/Element.html">Element</a></li>
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/Event.Emitter.html">Event.Emitter</a></li>
            
                <li><a href="../classes/Event.Listener.html">Event.Listener</a></li>
            
                <li><a href="../classes/Function.html">Function</a></li>
            
                <li><a href="../classes/IO.html">IO</a></li>
            
                <li><a href="../classes/ITSA.html">ITSA</a></li>
            
                <li><a href="../classes/NodeList.html">NodeList</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/Promise.html">Promise</a></li>
            
                <li><a href="../classes/String.html">String</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
                <li><a href="../classes/window.html">window</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/dom-ext.html">dom-ext</a></li>
            
                <li><a href="../modules/event.html">event</a></li>
            
                <li><a href="../modules/event-dom.html">event-dom</a></li>
            
                <li><a href="../modules/event-dragdrop.html">event-dragdrop</a></li>
            
                <li><a href="../modules/event-emitter.html">event-emitter</a></li>
            
                <li><a href="../modules/event-hover.html">event-hover</a></li>
            
                <li><a href="../modules/event-listener.html">event-listener</a></li>
            
                <li><a href="../modules/event-mobile.html">event-mobile</a></li>
            
                <li><a href="../modules/io.html">io</a></li>
            
                <li><a href="../modules/io-assets.html">io-assets</a></li>
            
                <li><a href="../modules/io-cors.html">io-cors</a></li>
            
                <li><a href="../modules/io-jsonp.html">io-jsonp</a></li>
            
                <li><a href="../modules/io-transfer.html">io-transfer</a></li>
            
                <li><a href="../modules/io-xml.html">io-xml</a></li>
            
                <li><a href="../modules/itsa.build.html">itsa.build</a></li>
            
                <li><a href="../modules/js-ext.html">js-ext</a></li>
            
                <li><a href="../modules/lib_array.js.html">lib/array.js</a></li>
            
                <li><a href="../modules/lib_document.js.html">lib/document.js</a></li>
            
                <li><a href="../modules/lib_element.js.html">lib/element.js</a></li>
            
                <li><a href="../modules/lib_function.js.html">lib/function.js</a></li>
            
                <li><a href="../modules/lib_nodelist.js.html">lib/nodelist.js</a></li>
            
                <li><a href="../modules/lib_object.js.html">lib/object.js</a></li>
            
                <li><a href="../modules/lib_promise.s.html">lib/promise.s</a></li>
            
                <li><a href="../modules/lib_string.js.html">lib/string.js</a></li>
            
                <li><a href="../modules/node-win.html">node-win</a></li>
            
                <li><a href="../modules/utils.html">utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/event-dom/extra/dragdrop.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;

/**
 * Adds the &#x60;hover&#x60; event as a DOM-event to event-dom. more about DOM-events:
 * http://www.smashingmagazine.com/2013/11/12/an-introduction-to-dom-events/
 *
 * More about drag and drop: https://dev.opera.com/articles/drag-and-drop/
 *
 *
 * &lt;i&gt;Copyright (c) 2014 ITSA - https://github.com/itsa&lt;/i&gt;
 * New BSD License - http://choosealicense.com/licenses/bsd-3-clause/
 *
 * @example
 * Event = require(&#x27;event-dom/dragdrop.js&#x27;)(window);
 *
 * or
 *
 * @example
 * Event = require(&#x27;event-dom&#x27;)(window);
 * require(&#x27;event-dom/event-dragdrop.js&#x27;)(window);
 *
 * @module event
 * @submodule event-dragdrop
 * @class Event
 * @since 0.0.2
*/


var NAME = &#x27;[event-dragdrop]: &#x27;,
    ZINDEX_DURING_DRAG = 999,
    CTRL_PRESSED = false,
    Z_INDEX = &#x27;z-index&#x27;,
    PREV_Z = &#x27;_prevZ&#x27;,
    DRAGGABLE = &#x27;draggable&#x27;,
    DD_DRAGGING_CLASS = &#x27;dd-dragging&#x27;,
    CONSTRAIN_ATTR = &#x27;xy-constrain&#x27;,
    PROXY = &#x27;proxy&#x27;,
    MOUSE = &#x27;mouse&#x27;,
    DATA_KEY = &#x27;dragDrop&#x27;,
    DATA_KEY_DROPZONE = &#x27;dropZone&#x27;,
    DD_EFFECT_ALLOWED = &#x27;dd-effect-allowed&#x27;,
    DD_DROPZONE = &#x27;dd-dropzone&#x27;,
    NO_TRANS_CLASS = &#x27;el-notrans&#x27;, // delivered by &#x60;dom-ext&#x60;
    INVISIBLE_CLASS = &#x27;el-invisible&#x27;, // delivered by &#x60;dom-ext&#x60;
    DD_TRANSITION_CLASS = &#x27;dd-transition&#x27;,
    DD_OPACITY_CLASS = &#x27;dd-opacity&#x27;,
    HIGH_Z_CLASS = &#x27;dd-high-z&#x27;,
    DD_DROPACTIVE_CLASS = &#x27;dropactive&#x27;,
    REGEXP_MOVE = /\bmove\b/i,
    REGEXP_COPY = /\bcopy\b/i,
    LATER = require(&#x27;utils&#x27;).later;

require(&#x27;polyfill/polyfill-base.js&#x27;);
require(&#x27;js-ext&#x27;);
require(&#x27;../css/dragdrop.css&#x27;);
require(&#x27;./hover.js&#x27;);

module.exports = function (window) {
    var Event = require(&#x27;../event-dom.js&#x27;)(window),
        UA = window.navigator.userAgent,
        iOS = !!UA.match(&#x27;iPhone OS&#x27;) || !!UA.match(&#x27;iPad&#x27;),
        dragOverPromiseList = [],
        featureDetect_DD, supportsDD, setupDD, teardownDD, handleMove, handleDrop, teardownDragOverEvent, allowSwitch, _getAllowedEffects,
        handleDragStart, currentNode, allowCopy, movableNode, setupDragOverEvent, dragOverEvent, lastMouseOverNode, onlyCopy, dropEffect,
        lastMouseX, lastMouseY, setBack;

    require(&#x27;window-ext&#x27;)(window);
    require(&#x27;dom-ext&#x27;)(window);

    featureDetect_DD = function() {
        var div = window.document.createElement(&#x27;div&#x27;);
        return (DRAGGABLE in div) || (&#x27;ondragstart&#x27; in div &amp;&amp; &#x27;ondrop&#x27; in div);
    };

    supportsDD = featureDetect_DD();

    // if supportsDD &amp;&amp; !iOS, then we can use native HTML5 drag and drop
    // no polyfill needed

    // iOS claims that draggable is in the element but doesn&#x27;t allow drag and drop:
    // https://developer.apple.com/library/safari/documentation/AppleApplications/Reference/SafariWebContent/HandlingEvents/HandlingEvents.html

    if (iOS || !supportsDD) {
        // we need a custom drag and drop solution
    }

    _getAllowedEffects = function(node) {
        var allowedEffects = node.getAttr(DD_EFFECT_ALLOWED);
        allowedEffects &amp;&amp; (allowedEffects=allowedEffects.toLowerCase());
        return allowedEffects || &#x27;move&#x27;;
    };

    allowCopy = function(node) {
        var allowedEffects = _getAllowedEffects(node);
        return (allowedEffects===&#x27;all&#x27;) || (allowedEffects===&#x27;copy&#x27;);
    };

    onlyCopy = function(node) {
        var allowedEffects = _getAllowedEffects(node);
        return (allowedEffects===&#x27;copy&#x27;);
    };

    allowSwitch = function(node) {
        var allowedEffects = _getAllowedEffects(node);
        return (allowedEffects===&#x27;all&#x27;);
    };

    setupDragOverEvent = function() {
        var dropzones = window.document.getAll(&#x27;[dropzone]&#x27;);
        if (dropzones.length&gt;0) {
            dragOverEvent = Event.after([&#x27;mousemove&#x27;, &#x27;dd-fake-mousemove&#x27;], function(e) {
                if (currentNode) {
                    lastMouseOverNode = e.target;
                    dropzones.forEach(
                        function(dropzone) {
                            if (dropzone.hasData(DATA_KEY_DROPZONE)) {
                                return;
                            }
                            var dropzoneAccept = dropzone.getAttr(&#x27;dropzone&#x27;) || &#x27;&#x27;,
                                dropzoneMove = REGEXP_MOVE.test(dropzoneAccept),
                                dropzoneCopy = REGEXP_COPY.test(dropzoneAccept),
                                dragOverPromise, dragOutEvent, eventobject, allowed;

                            if (e.clientX) {
                                lastMouseX = e.clientX+window.getScrollLeft();
                                lastMouseY = e.clientY+window.getScrollTop();
                            }

                            // check if the mouse is inside the dropzone
                            // also check if the mouse is inside the dragged node: the dragged node might have been constrained
                            // and check if the dragged node is allowed to go into the dropzone
                            allowed = (!dropzoneMove &amp;&amp; !dropzoneCopy) || (dropzoneCopy &amp;&amp; (dropEffect===&#x27;copy&#x27;)) || (dropzoneMove &amp;&amp; (dropEffect===&#x27;move&#x27;));
                            if (dropEffect &amp;&amp; allowed &amp;&amp; dropzone.insidePos(lastMouseX, lastMouseY) &amp;&amp; movableNode.insidePos(lastMouseX, lastMouseY)) {
                                dropzone.setData(DATA_KEY_DROPZONE, true);
                                // mouse is in area of dropzone
                                dragOverPromise = Promise.manage();
                                eventobject = {
                                    target: dropzone,
                                    dragover: dragOverPromise
                                };
                                dragOutEvent = Event.after(
                                    [&#x27;mousemove&#x27;, &#x27;dd-fake-mousemove&#x27;],
                                    function(ev) {
                                        dragOverPromise.fulfill(ev.target);
                                    },
                                    function(ev) {
                                        var allowed, dropzoneAccept, dropzoneMove, dropzoneCopy;
                                        if (ev.type===&#x27;dd-fake-mousemove&#x27;) {
                                            dropzoneAccept = dropzone.getAttr(&#x27;dropzone&#x27;) || &#x27;&#x27;;
                                            dropzoneMove = REGEXP_MOVE.test(dropzoneAccept);
                                            dropzoneCopy = REGEXP_COPY.test(dropzoneAccept);
                                            allowed = (!dropzoneMove &amp;&amp; !dropzoneCopy) || (dropzoneCopy &amp;&amp; (dropEffect===&#x27;copy&#x27;)) || (dropzoneMove &amp;&amp; (dropEffect===&#x27;move&#x27;));
                                            return !allowed;
                                        }
                                        return !dropzone.insidePos(ev.clientX+window.getScrollLeft(), ev.clientY+window.getScrollTop());
                                    }
                                );
                                dragOverPromise.finally(
                                    function() {
                                        dragOutEvent.detach();
                                        dropzone.removeData(DATA_KEY_DROPZONE);
                                    }
                                );
                                dragOverPromiseList.push(dragOverPromise);
                                Event.emit(dropzone, &#x27;UI:dd-dragover&#x27;, eventobject);
                            }
                        }
                    );
                }
            });
        }
    };

    teardownDragOverEvent = function() {
        if (dragOverEvent) {
            dragOverEvent.detach();
            dragOverPromiseList.forEach(function(promise) {
                promise.fulfill(lastMouseOverNode);
            });
            dragOverPromiseList.length = 0;
        }
        dragOverEvent = null;
    };

    /*
     * Creates the &#x60;hover&#x60; event. The eventobject has the property &#x60;e.hover&#x60; which is a &#x60;Promise&#x60;.
     * You can use this Promise to get notification of the end of hover. The Promise e.hover gets resolved with
     * &#x60;relatedTarget&#x60; as argument: the node where the mouse went into when leaving a.target.
     *
     * @method setupHover
     * @private
     * @since 0.0.2
     */
    setupDD = function() {

        Event.after([&#x27;keydown&#x27;, &#x27;keyup&#x27;], function(e) {
            CTRL_PRESSED = e.ctrlKey || e.metaKey;
            if (currentNode &amp;&amp; allowSwitch(currentNode)) {
                dropEffect = CTRL_PRESSED ? &#x27;copy&#x27; : &#x27;move&#x27;;
                if (CTRL_PRESSED) {
                    currentNode.removeClass(INVISIBLE_CLASS);
                    movableNode.setClass(DD_OPACITY_CLASS);
                }
                else {
                    currentNode.setClass(INVISIBLE_CLASS);
                    movableNode.removeClass(DD_OPACITY_CLASS);
                }
                // now, it could be that any droptarget should change its appearance (DD_DROPACTIVE_CLASS).
                // we need to recalculate it for all targets
                // we do this by emitting a &#x27;dd-fake-mousemove&#x27; event
                lastMouseOverNode &amp;&amp; Event.emit(lastMouseOverNode, &#x27;UI:dd-fake-mousemove&#x27;);
            }
        });

        // prevent contextmenu on draggable elements that have the ability to copy themselves:
        window.oncontextmenu = function () {
            return currentNode ? !allowCopy(currentNode) : true;
        };

        Event.after(&#x27;dd-dragover&#x27;, function(e) {
            console.log(NAME, &#x27;dragged over&#x27;);
            e.target.setClass(DD_DROPACTIVE_CLASS);
            e.dragover.then(
                function() {
                    e.target.removeClass(DD_DROPACTIVE_CLASS);
                }
            );
        });

        Event.before([MOUSE+&#x27;down&#x27;, &#x27;panstart&#x27;], function(e) {
            console.log(NAME, &#x27;setupHover: setting up mouseover event&#x27;);
            var node = e.target,
                moveEv, evtType, x, y;

            // because we listen to 2 eventypes, but we don&#x27;t want to setup twice, we need to store
            // data on the node that tells whether dragging already started
            if (currentNode) {
                return;
            }

            currentNode = node;

            // we set data to the node: key=&#x27;dragDrop&#x27; value=xy-position, which we may need
            // to return a proxy on drop-fail
            x = node.getX();
            y = node.getY();
            // now we can read their current inline values
            node.setData(DATA_KEY, {
                x: x,
                y: y,
                xStart: node.getInlineStyle(&#x27;left&#x27;),
                yStart: node.getInlineStyle(&#x27;top&#x27;),
                mousex: e.clientX+window.getScrollLeft(),
                mousey: e.clientY+window.getScrollTop()
            });

            evtType = (e.type===MOUSE+&#x27;down&#x27;) ? MOUSE : &#x27;pan&#x27;;

            e.drag = Promise.manage();

            e.setOnDrag = function(callbackFn) {
                e.drag.setCallback(callbackFn);
            };

            moveEv = Event.after(evtType+&#x27;move&#x27;, function(ev) {
                // move the object
                handleMove(e, ev);
                e.drag.callback(e);
            });

            Event.onceAfter((evtType===MOUSE) ? MOUSE+&#x27;up&#x27; : &#x27;panend&#x27;, function(ev) {
                moveEv.detach();
                // handle drop
                movableNode.hasAttr(DD_DROPZONE) &amp;&amp; handleDrop(e, ev);
                currentNode = null;
                e.dragFinished = true;
                node.removeData(DATA_KEY);
                teardownDragOverEvent();
                e.drag.fulfill(e);
            });

            setupDragOverEvent();
            handleDragStart(e, x, y);

            Event.emit(node, &#x27;UI:dd-drop&#x27;, e);
        }, &#x27;[draggable=&quot;true&quot;]&#x27;);
    };

    handleDragStart = function(e, x, y) {
        var proxy = currentNode.hasAttr(DD_DROPZONE);

        movableNode = proxy ? currentNode.clone(true) : currentNode;


        movableNode.setClass(NO_TRANS_CLASS).setClass(HIGH_Z_CLASS);

        if (proxy) {
            dropEffect = (onlyCopy(currentNode) || (CTRL_PRESSED &amp;&amp; allowCopy(currentNode))) ? &#x27;copy&#x27; : &#x27;move&#x27;;
            (dropEffect===&#x27;copy&#x27;) ? movableNode.setClass(DD_OPACITY_CLASS) : currentNode.setClass(INVISIBLE_CLASS);
            movableNode.setClass(INVISIBLE_CLASS);
            currentNode.parentNode.append(movableNode);
            movableNode.setXY(x, y, true);
            movableNode.removeClass(INVISIBLE_CLASS);
        }
        else {
            dropEffect = null;
            movableNode.setXY(x, y, true);
        }
    };

    handleMove = function(e, ev) {
console.info(&#x27;DragMove &#x27;+movableNode.id);
        if (e.dragFinished) {
            return;
        }
        var data = movableNode.getData(DATA_KEY);
        movableNode.setClass(DD_DRAGGING_CLASS);
        movableNode.setXY(data.x+ev.clientX+window.getScrollLeft()-data.mousex, data.y+ev.clientY+window.getScrollTop()-data.mousey, true);
    };

    handleDrop = function(e, ev) {
console.info(&#x27;DragDrop &#x27;+movableNode.id);
        var targetNode, originalConstrain;

        window.document.getAll(&#x27;[dropzone]&#x27;).some(function(dropzone) {
            if (dropzone.hasData(DATA_KEY_DROPZONE)) {
                targetNode = dropzone;
            }
            return targetNode;
        });
        if (targetNode) {
            targetNode.append(currentNode);
            originalConstrain = currentNode.getAttr(CONSTRAIN_ATTR);
            currentNode.setAttr(CONSTRAIN_ATTR, &#x27;[dropzone]&#x27;);
            currentNode.setXY(movableNode.getX(), movableNode.getY());
            currentNode.setAttr(CONSTRAIN_ATTR, originalConstrain);
            currentNode.removeClass(INVISIBLE_CLASS);
            movableNode.remove();
        }
        else {
            setBack(e, ev);
        }
    };

    setBack = function(e, ev) {
console.info(&#x27;setBack &#x27;+movableNode.id);
        var proxy = movableNode.hasAttr(DD_DROPZONE),
            data = movableNode.getData(DATA_KEY),
            tearDown;
        tearDown = function(notransRemoval) {
            notransRemoval || (movableNode.removeEventListener &amp;&amp; movableNode.removeEventListener(&#x27;transitionend&#x27;, tearDown, true));
            if (proxy) {
                // we must take e.target instead of currentNode --&gt; because asynchronisity, currentNode is already null
                e.target.removeClass(INVISIBLE_CLASS);
                movableNode.remove();
            }
            else {
                movableNode.removeClass(DD_TRANSITION_CLASS).removeClass(HIGH_Z_CLASS);
            }
        };

        movableNode.removeClass(NO_TRANS_CLASS);

        if (movableNode.hasClass(DD_DRAGGING_CLASS)) {
            movableNode.removeClass(DD_DRAGGING_CLASS);
            movableNode.setClass(DD_TRANSITION_CLASS);
            // transitions only work with IE10+, and that browser has addEventListener
            // when it doesn&#x27;t have, it doesn;t harm to leave the transitionclass on: it would work anyway
            // nevertheless we will remove it with a timeout
            if (movableNode.addEventListener) {
                movableNode.addEventListener(&#x27;transitionend&#x27;, tearDown, true);
            }
            else {
                LATER(tearDown, 250);
            }
        }
        else {
            tearDown(true);
        }
        movableNode.setInlineStyle(&#x27;left&#x27;, data.xStart);
        movableNode.setInlineStyle(&#x27;top&#x27;, data.yStart);

    };

    setupDD();

    // also extend window.Element:
    window.Element &amp;&amp; (function(ElementPrototype) {
       /**
        * Makes the HtmlElement draggable
        *
        * @method setDraggable
        * @param [proxy] {Boolean} whether the HtmlElement is a proxy-node during drag
        * @chainable
        * @since 0.0.1
        */
        ElementPrototype.setDraggable = function(proxy) {
            this.setAttr(DRAGGABLE, proxy ? PROXY : &quot;true&quot;);
            return this;
        };
       /**
        * Removes draggability of the HtmlElement
        *
        * @method removeDraggable
        * @chainable
        * @since 0.0.1
        */
        ElementPrototype.removeDraggable = function() {
            this.removeAttr(DRAGGABLE);
            return this;
        };
    }(window.Element.prototype));

    return Event;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
